name: CI
on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*.*.*'
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  pull_request:
    paths-ignore:
      - "docs/**"
      - "**/*.md"

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  android:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            apps/demo/package-lock.json
      - name: Ensure npm 10
        run: npm install -g npm@10
      - name: Install JS deps
        run: npm install
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: gradle
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('apps/demo/android/gradle/wrapper/gradle-wrapper.properties', 'apps/demo/android/gradle.properties', 'apps/demo/android/build.gradle', 'apps/demo/android/settings.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Build Android Debug
        run: cd apps/demo/android && ./gradlew assembleStagingDebug

  ios:
    runs-on: macos-15
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            apps/demo/package-lock.json
      - name: Ensure npm 10
        run: npm install -g npm@10
      - name: Install JS deps
        run: npm install
      - name: Cache Ruby gems
        uses: actions/cache@v4
        with:
          path: |
            apps/demo/vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('apps/demo/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-
      - name: Install CocoaPods
        run: |
          gem install bundler -v 4.0.4
          cd apps/demo/ios
          LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8 bundle _4.0.4_ install
          bundle _4.0.4_ exec pod install
      - name: Select iOS simulator
        id: sim
        run: |
          SIM_NAME=$(xcrun simctl list devices available | awk -F ' \(' '/iPhone/ {print $1; exit}')
          if [ -z "$SIM_NAME" ]; then
            echo "No available iPhone simulator found."
            xcrun simctl list devices
            exit 1
          fi
          echo "name=$SIM_NAME" >> "$GITHUB_OUTPUT"
      - name: Build iOS
        run: xcodebuild -workspace apps/demo/ios/SGReactNativeKit.xcworkspace -scheme SGReactNativeKit -configuration Debug -sdk iphonesimulator -destination "platform=iOS Simulator,name=${{ steps.sim.outputs.name }}"

  aar:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            apps/demo/package-lock.json
      - name: Ensure npm 10
        run: npm install -g npm@10
      - name: Install JS deps
        run: npm install
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: gradle
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('apps/demo/android/gradle/wrapper/gradle-wrapper.properties', 'apps/demo/android/gradle.properties', 'apps/demo/android/build.gradle', 'apps/demo/android/settings.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Build RN library AAR
        run: cd apps/demo/android && ./gradlew :rnlib:assembleRelease
      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: rnlib-release-aar
          path: apps/demo/android/rnlib/build/outputs/aar/*.aar

  ios-artifact:
    runs-on: macos-15
    if: startsWith(github.ref, 'refs/tags/v')
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            apps/demo/package-lock.json
      - name: Ensure npm 10
        run: npm install -g npm@10
      - name: Install JS deps
        run: npm install
      - name: Cache Ruby gems
        uses: actions/cache@v4
        with:
          path: |
            apps/demo/vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('apps/demo/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-
      - name: Install CocoaPods
        run: |
          gem install bundler -v 4.0.4
          cd apps/demo/ios
          LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8 bundle _4.0.4_ install
          bundle _4.0.4_ exec pod install
      - name: Build iOS JS bundle
        run: ./packages/sg-react-native-kit/scripts/bundle-ios.sh
      - name: Package iOS artifact
        run: |
          zip -r ios-artifact.zip             apps/demo/ios/SGReactNativeKit/Resources             SGReactNativeKit.podspec
      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifact
          path: ios-artifact.zip

  auto-tag:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Read version
        id: version
        run: echo "version=$(node -p 'require(\"./packages/sg-react-native-kit/package.json\").version')" >> $GITHUB_OUTPUT
      - name: Create tag if missing
        run: |
          TAG=v${{ steps.version.outputs.version }}
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Skipping."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$TAG"
          git push origin "$TAG"

