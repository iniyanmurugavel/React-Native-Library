name: CI
on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*.*.*'
  pull_request:

permissions:
  contents: write

jobs:
  android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install JS deps
        run: npm ci
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties', 'android/gradle.properties', 'android/build.gradle', 'android/settings.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Build Android Debug
        run: cd android && ./gradlew assembleStagingDebug

  ios:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install JS deps
        run: npm ci
      - name: Install CocoaPods
        run: |
          gem install bundler -v 4.0.4
          cd ios
          LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8 bundle _4.0.4_ install
          bundle _4.0.4_ exec pod install
      - name: Build iOS
        run: xcodebuild -workspace ios/SGReactNativeKit.xcworkspace -scheme SGReactNativeKit -configuration Debug -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 15'

  aar:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install JS deps
        run: npm ci
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties', 'android/gradle.properties', 'android/build.gradle', 'android/settings.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Build RN library AAR
        run: cd android && ./gradlew :rnlib:assembleRelease
      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: rnlib-release-aar
          path: android/rnlib/build/outputs/aar/*.aar

  ios-artifact:
    runs-on: macos-15
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install JS deps
        run: npm ci
      - name: Install CocoaPods
        run: |
          gem install bundler -v 4.0.4
          cd ios
          LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8 bundle _4.0.4_ install
          bundle _4.0.4_ exec pod install
      - name: Build iOS JS bundle
        run: ./scripts/bundle-ios.sh
      - name: Package iOS artifact
        run: |
          zip -r ios-artifact.zip             ios/SGReactNativeKit/Resources             SGReactNativeKit.podspec
      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifact
          path: ios-artifact.zip

  auto-tag:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Read version
        id: version
        run: echo "version=$(node -p 'require(\"./package.json\").version')" >> $GITHUB_OUTPUT
      - name: Create tag if missing
        run: |
          TAG=v${{ steps.version.outputs.version }}
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Skipping."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$TAG"
          git push origin "$TAG"

